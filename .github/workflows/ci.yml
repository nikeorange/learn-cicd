name: .NET CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

env:
  DOTNET_VERSION: '10.0'

jobs:
  # –ó–ê–î–ê–ß–ê 1: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    # –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --no-restore --configuration Release
    
    - name: Test
      run: dotnet test --no-build --verbosity normal
    
    # –°–û–ó–î–ê–ï–ú –ê–†–¢–ï–§–ê–ö–¢ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π
    - name: Create and upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: simpleapp-release
        path: |
          **/bin/Release/**
          **/obj/Release/**
        if-no-files-found: error
  
  # –ó–ê–î–ê–ß–ê 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
  code-quality:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0'
    
    - name: Check code formatting
      run: |
        dotnet tool install -g dotnet-format
        dotnet format --check --verbosity diagnostic
        
    - name: Check for vulnerabilities
      run: |
        dotnet list package --vulnerable
  
  # –ó–ê–î–ê–ß–ê 3: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
      id-token: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/my-first-cicd:latest
          ghcr.io/${{ github.repository_owner }}/my-first-cicd:${{ github.sha }}
        labels: |
          org.opencontainers.image.source=${{ github.event.repository.html_url }}
  
  # –ó–ê–î–ê–ß–ê 4: –î–µ–ø–ª–æ–π (—Å–∏–º—É–ª—è—Ü–∏—è)
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: simpleapp-release
        path: ./downloaded-artifacts
    
    - name: Show artifact contents
      run: |
        echo "üì¶ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤:"
        find ./downloaded-artifacts -type f | head -20
    
    - name: Simulate deployment
      run: |
        echo "üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –î–ï–ü–õ–û–ô!"
        echo "====================="
        echo "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}"
        echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"
        echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo "–í—Ä–µ–º—è: $(date)"
        echo ""
        echo "‚úÖ –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ"
        echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        echo "‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–∑–¥–∞–Ω"
        echo ""
        echo "üìã –î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ):"
        echo "1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É"
        echo "2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤"
        echo "3. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏"
        echo "4. –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏"
        echo "5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è"
        echo ""
        echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"