name: .NET CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

env:
  DOTNET_VERSION: '10.0'

jobs:
  # –ó–ê–î–ê–ß–ê 1: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    # –ö–≠–®–ò–†–û–í–ê–ù–ò–ï –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
    - name: Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --no-restore --configuration Release
    
    - name: Test
      run: dotnet test --no-build --verbosity normal
    
    # –°–û–ó–î–ê–ï–ú –ê–†–¢–ï–§–ê–ö–¢ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏)
    - name: Create artifact
      run: |
        mkdir -p publish
        dotnet publish SimpleApp/SimpleApp.csproj -c Release -o publish
      if: success()
    
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: simpleapp-release
        path: publish/
      if: success()
  
  # –ó–ê–î–ê–ß–ê 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
  code-quality:
    runs-on: ubuntu-latest
    needs: build-and-test  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0'
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
    - name: Check code formatting
      run: |
        dotnet tool install -g dotnet-format
        dotnet format --check --verbosity diagnostic
        
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
    - name: Check for vulnerabilities
      run: |
        dotnet list package --vulnerable
  
  # –ó–ê–î–ê–ß–ê 3: –î–µ–ø–ª–æ–π (—É—Å–ª–æ–≤–Ω—ã–π)
  deploy:
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality]
    if: github.ref == 'refs/heads/main'  # –¢–æ–ª—å–∫–æ –¥–ª—è main –≤–µ—Ç–∫–∏
    
    steps:
    - name: Download artifact
      uses: actions/download-artifact@v3
      with:
        name: simpleapp-release
    
    - name: Simulate deployment
      run: |
        echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π!"
        echo "–í–µ—Ä—Å–∏—è: 1.0.0"
        echo "–í—Ä–µ–º—è: $(date)"
        echo ""
        echo "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã:"
        ls -la
        echo ""
        echo "üì¶ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é!"
        echo ""
        echo "–í —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–æ –±—ã:"
        echo "1. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä"
        echo "2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É–∂–±"
        echo "3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
        echo "4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è"