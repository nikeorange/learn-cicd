name: .NET CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  DOTNET_VERSION: '10.0'

jobs:
  # –ó–ê–î–ê–ß–ê 1: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–û–°–ù–û–í–ù–ê–Ø)
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build --configuration Release
    
    - name: Test
      run: dotnet test --verbosity normal
    
    - name: Test with reports
      run: |
        dotnet test \
          --logger "trx;LogFileName=test-results.trx" \
          --logger "html;LogFileName=test-report.html" \
          --collect:"XPlat Code Coverage" \
          --results-directory TestResults  

    - name: Upload test results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: TestResults/
      if: always()   

    - name: Show success
      run: echo "‚úÖ Build and tests completed successfully!"
  
  # –ó–ê–î–ê–ß–ê 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø)
  code-quality:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0'
    
    # –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
    - name: Check code formatting
      run: |
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º dotnet-format
        dotnet tool install -g dotnet-format
        
        # –ò—â–µ–º —Ñ–∞–π–ª —Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–æ–µ–∫—Ç
        if [ -f "MyWebApiSolution.sln" ]; then
          echo "Found solution file, checking formatting..."
          dotnet-format MyWebApiSolution.sln --check --verbosity diagnostic
        elif [ -f "MyWebApi/MyWebApi.csproj" ]; then
          echo "Found project file, checking formatting..."
          dotnet-format MyWebApi/MyWebApi.csproj --check --verbosity diagnostic
        else
          echo "No solution or project file found, skipping format check"
        fi
    
    # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
    - name: Check for vulnerabilities
      run: |
        echo "Checking package vulnerabilities..."
        dotnet list MyWebApi/MyWebApi.csproj package --vulnerable || echo "No vulnerabilities found or project not found"
  
  # –ó–ê–î–ê–ß–ê 3: –î–µ–ø–ª–æ–π (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π)
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Simulate deployment
      run: |
        echo "üöÄ –î–ï–ü–õ–û–ô –ù–ê–ß–ê–¢!"
        echo "================="
        echo "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: ${{ github.repository }}"
        echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"
        echo ""
        echo "üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´:"
        echo "‚úÖ –°–±–æ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ"
        echo "‚úÖ –¢–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã"
        echo ""
        echo "üéâ –ì–æ—Ç–æ–≤–æ! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å."


 # –ó–ê–î–ê–ß–ê 4: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:latest
          ghcr.io/${{ github.repository }}:${{ github.sha }}
        labels: |
          org.opencontainers.image.source=${{ github.event.repository.html_url }}